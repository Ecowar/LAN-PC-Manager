<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç”µè„‘æ§åˆ¶ä¸­å¿ƒ</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    min-height: 100vh;
    background: linear-gradient(135deg, #f0f2f5 0%, #e3e8f0 100%);
    font-family: Arial, sans-serif;
    color: #333;
}
.container {
    padding: 15px;
    max-width: 600px;
    margin: 0 auto;
}
/* é¡¶éƒ¨å¯¼èˆªæ  */
.nav-bar {
    background: #fff;
    border-radius: 14px;
    padding: 10px;
    margin-bottom: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
}
.nav-btn {
    flex: 1;
    min-width: 80px;
    padding: 10px;
    font-size: 12px;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
    font-weight: 500;
}
.nav-btn:hover {
    transform: translateY(-1px);
}
.nav-btn.active {
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8) inset;
}
.card {
    background: #fff;
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}
h2 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 14px;
    color: #333;
    display: flex;
    align-items: center;
}
h2::before {
    margin-right: 8px;
}
input {
    width: 100%;
    padding: 14px;
    font-size: 15px;
    border: 1px solid #ddd;
    border-radius: 10px;
    margin-bottom: 12px;
    box-sizing: border-box;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}
input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}
button {
    width: 100%;
    padding: 15px;
    font-size: 15px;
    border: none;
    border-radius: 10px;
    color: white;
    margin-bottom: 10px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
    font-weight: 500;
}
button:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
button:active {
    transform: translateY(1px);
}
.btn-blue {
    background: linear-gradient(135deg, #007bff 0%, #0069d9 100%);
}
.btn-blue:hover {
    background: linear-gradient(135deg, #0069d9 0%, #005cbf 100%);
}
.btn-red {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}
.btn-red:hover {
    background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
}
.btn-orange {
    background: linear-gradient(135deg, #fd7e14 0%, #e96900 100%);
}
.btn-orange:hover {
    background: linear-gradient(135deg, #e96900 0%, #d35400 100%);
}
.btn-green {
    background: linear-gradient(135deg, #28a745 0%, #218838 100%);
}
.btn-green:hover {
    background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
}
.btn-purple {
    background: linear-gradient(135deg, #6f42c1 0%, #5a30a0 100%);
}
.btn-purple:hover {
    background: linear-gradient(135deg, #5a30a0 0%, #4a278a 100%);
}
.btn-teal {
    background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
}
.btn-teal:hover {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
}

/* å¸§ç‡æ§åˆ¶ç›¸å…³æ ·å¼ */
.fps-control {
    position: relative;
    display: inline-block;
}

.fps-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 5px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 80px;
    z-index: 1000;
    overflow: hidden;
}

.fps-option {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease;
}

.fps-option:hover {
    background-color: #007bff;
    color: white;
}

.fps-counter {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    font-weight: bold;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 8px;
    color: #28a745; /* ç»¿è‰²ï¼Œâ‰¥20fps */
}

.fps-counter.yellow {
    color: #ffc107; /* é»„è‰²ï¼Œ10-20fps */
}

.fps-counter.red {
    color: #dc3545; /* çº¢è‰²ï¼Œ<10fps */
}

/* æ§åˆ¶æ æŒ‰é’®æ ·å¼ */
.btn-blue, .btn-green, .btn-red, .btn-orange, .btn-teal, .btn-purple {
    padding: 8px 12px;
    font-size: 12px;
}

/* Toastæç¤ºæ¡†æ ·å¼ */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 400px;
}

.toast {
    min-width: 280px;
    max-width: 100%;
    padding: 16px 20px;
    border-radius: 12px;
    color: white;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
    transform: translateX(100%);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    cursor: pointer;
}

.toast::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: rgba(255, 255, 255, 0.8);
}

.toast.success {
    background: linear-gradient(135deg, #28a745 0%, #218838 100%);
}

.toast.error {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}

.toast.warning {
    background: linear-gradient(135deg, #fd7e14 0%, #e96900 100%);
}

.toast.info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.hide {
    transform: translateX(100%);
    opacity: 0;
}

.toast-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.toast-icon {
    font-size: 18px;
}

.toast-message {
    flex: 1;
    word-break: break-word;
}

.toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 2px;
    background: rgba(255, 255, 255, 0.6);
    width: 100%;
    transition: width 0.1s linear;
}

/* ToaståŠ è½½å›¾æ ‡ */
.toast-loading {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 480px) {
    .container {
        padding: 12px;
    }
    .nav-bar {
        padding: 8px;
        margin-bottom: 12px;
    }
    .nav-btn {
        min-width: 70px;
        padding: 8px;
        font-size: 11px;
    }
    .card {
        padding: 16px;
        margin-bottom: 12px;
    }
    h2 {
        font-size: 16px;
    }
    input {
        padding: 12px;
        font-size: 14px;
    }
    button {
        padding: 13px;
        font-size: 14px;
    }
    
    /* ç§»åŠ¨ç«¯Toasté€‚é… */
    .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
        width: 90%;
        margin: 0 auto;
    }
    
    .toast {
        min-width: auto;
        max-width: 100%;
    }
}
</style>
</head>

<body>
<div class="container">

<div class="nav-bar">
<button class="nav-btn btn-red active" onclick="showSection('system')">ç³»ç»Ÿæ§åˆ¶</button>
<button class="nav-btn btn-orange" onclick="showSection('cmd')">æ‰§è¡Œå‘½ä»¤</button>
<button class="nav-btn btn-green" onclick="showSection('info')">ç³»ç»Ÿä¿¡æ¯</button>
<button class="nav-btn btn-teal" onclick="showSection('screen')">å±å¹•ç”»é¢</button>
<button class="nav-btn btn-purple" onclick="showSection('message')">æ¶ˆæ¯ä¸­å¿ƒ</button>
<button class="nav-btn btn-blue" onclick="showSection('file')">æ–‡ä»¶ç®¡ç†</button>
<button class="nav-btn btn-blue" onclick="showSection('about')">å…³äº</button>
</div>

<!-- å…³äºå¡ç‰‡ -->
<div class="card" id="about-section" style="display: none;">
<div style="text-align: center; margin-bottom: 15px;">
<div style="font-size: 48px; margin-bottom: 10px;">ğŸ–¥ï¸</div>
<h1 style="font-size: 18px; font-weight: bold; margin: 0 0 5px 0; color: #333;">ç”µè„‘æ§åˆ¶ä¸­å¿ƒ</h1>
<p style="font-size: 14px; color: #666; margin: 0;">v1.2.6</p>
</div>
<div style="background: #f8f9fa; border-radius: 8px; overflow: hidden;">
<div style="padding: 10px; background: #e9ecef; font-weight: bold; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #dee2e6;">
<span>ğŸ“‹</span>
<span>æ›´æ–°æ—¥å¿—</span>
</div>
<div style="max-height: 120px; overflow-y: auto; padding: 10px;">
<div style="margin-bottom: 15px;">
<div style="font-weight: bold; margin-bottom: 5px;">v1.2.6</div>
<ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
<li>æ–°å¢æ–‡ä»¶ç®¡ç†åŠŸèƒ½ï¼Œæ”¯æŒå‘é€æ–‡ä»¶åˆ°ç”µè„‘</li>
<li>æ–°å¢å®æ—¶å±å¹•FPSæ˜¾ç¤ºï¼ˆæœ‰ç‚¹ä¸å‡†ç¡®ï¼‰</li>
<li>æ–°å¢å®æ—¶è¿æ¥çŠ¶æ€æ˜¾ç¤º</li>
<li>ä¿®å¤æ–‡ä»¶ä¼ è¾“åŠŸèƒ½çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œæ”¹ä¸ºç£ç›˜æµå¼å­˜å‚¨</li>
</ul>
</div>
<div style="margin-bottom: 15px;">
<div style="font-weight: bold; margin-bottom: 5px;">v1.2.5</div>
<ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
<li>æ–°å¢å³ä¸Šè§’æç¤ºæ¡†ç³»ç»Ÿï¼Œæ”¯æŒæˆåŠŸ/é”™è¯¯/è­¦å‘Š/ä¿¡æ¯å››ç§ç±»å‹</li>
<li>æ–°å¢å®æ—¶ç”»é¢ç”»è´¨é€‰æ‹©ï¼ˆä½/ä¸­/é«˜ä¸‰æ¡£ï¼‰</li>
<li>æ–°å¢å®æ—¶ç”»é¢å¸§ç‡é€‰æ‹©ï¼ˆ5/10/15/24/30/45/60 FPSï¼‰</li>
<li>æ¶ˆæ¯ç³»ç»Ÿæ”¹ä¸ºæœåŠ¡å™¨æ¨é€æœºåˆ¶ï¼ˆSSEï¼‰ï¼Œå®æ—¶æ¥æ”¶ç”µè„‘ç«¯å›å¤</li>
<li>ä¼˜åŒ–å®æ—¶ç”»é¢ï¼Œæ”¹ä¸ºMJPEGæµï¼Œé™ä½å»¶è¿Ÿå’Œå¸¦å®½å ç”¨</li>
<li>æ–°å¢è®¾ç½®æŒä¹…åŒ–åŠŸèƒ½ï¼Œç”»è´¨å’Œå¸§ç‡è®¾ç½®è‡ªåŠ¨ä¿å­˜</li>
</ul>
</div>
<div style="margin-bottom: 15px;">
<div style="font-weight: bold; margin-bottom: 5px;">v1.2.0</div>
<ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
<li>æ–°å¢æ¶ˆæ¯ä¸­å¿ƒåŒå‘é€šä¿¡</li>
<li>æ–°å¢åº”ç”¨ç®¡ç†åŠŸèƒ½ï¼ˆæŸ¥çœ‹/åœæ­¢è¿è¡Œåº”ç”¨ï¼‰</li>
<li>æ–°å¢å…³äºé¡µé¢å’Œç‰ˆæœ¬ä¿¡æ¯å±•ç¤º</li>
<li>ä¿®å¤å®æ—¶ç”»é¢å†…å­˜æ³„æ¼é—®é¢˜</li>
</ul>
</div>
<div style="margin-bottom: 15px;">
<div style="font-weight: bold; margin-bottom: 5px;">v1.1.0</div>
<ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
<li>æ–°å¢å±å¹•æˆªå›¾åŠŸèƒ½</li>
<li>æ–°å¢ç³»ç»Ÿæ—¥å¿—æŸ¥çœ‹åŠŸèƒ½</li>
<li>ä¼˜åŒ–å†…å­˜å’Œç£ç›˜æ•°æ®çš„æ ¼å¼åŒ–æ˜¾ç¤º</li>
<li>æ–°å¢å“åº”å¼è®¾è®¡ï¼Œé€‚é…ç§»åŠ¨ç«¯è®¿é—®</li>
<li>ä¿®å¤ç½‘ç»œæ•°æ®å•ä½æ˜¾ç¤ºé”™è¯¯</li>
</ul>
</div>
<div style="margin-bottom: 15px;">
<div style="font-weight: bold; margin-bottom: 5px;">v1.0.0</div>
<ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
<li>é¦–ä¸ªæ­£å¼ç‰ˆæœ¬å‘å¸ƒ</li>
<li>æ–°å¢å®šæ—¶å…³æœºåŠŸèƒ½</li>
<li>æ–°å¢å–æ¶ˆå…³æœºåŠŸèƒ½</li>
<li>æ–°å¢ç³»ç»Ÿå¯åŠ¨æ—¶é—´æ˜¾ç¤º</li>
<li>æ–°å¢ä¼‘çœ åŠŸèƒ½</li>
<li>å®Œå–„é”™è¯¯æç¤ºæœºåˆ¶</li>
</ul>
</div>
<div style="margin-bottom: 15px;">
<div style="font-weight: bold; margin-bottom: 5px;">v0.9.0</div>
<ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
<li>æ–°å¢ç³»ç»Ÿä¿¡æ¯å®æ—¶åˆ·æ–°åŠŸèƒ½</li>
<li>æ–°å¢ç£ç›˜ä½¿ç”¨æƒ…å†µæ˜¾ç¤º</li>
<li>æ–°å¢ç½‘ç»œæµé‡ç»Ÿè®¡ï¼ˆå‘é€/æ¥æ”¶ï¼‰</li>
<li>ä¼˜åŒ–é¡µé¢å¸ƒå±€ï¼Œé‡‡ç”¨å¡ç‰‡å¼è®¾è®¡</li>
<li>ä¿®å¤éƒ¨åˆ†æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜</li>
</ul>
</div>
<div style="margin-bottom: 15px;">
<div style="font-weight: bold; margin-bottom: 5px;">v0.8.0</div>
<ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
<li>é¡¹ç›®åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºç¡€æ¡†æ¶æ­å»º</li>
<li>å®ç°æ ¸å¿ƒç³»ç»Ÿæ§åˆ¶åŠŸèƒ½ï¼ˆå…³æœºã€é‡å¯ã€é”å±ï¼‰</li>
<li>æ”¯æŒæ‰§è¡ŒåŸºç¡€CMDå‘½ä»¤</li>
<li>ç®€å•çš„ç³»ç»Ÿä¿¡æ¯å±•ç¤ºï¼ˆCPUã€å†…å­˜ï¼‰</li>
</ul>
</div>
</div>
</div>
</div>

<div class="card" id="system-section">
<h2>ğŸ”Œ ç³»ç»Ÿæ§åˆ¶</h2>
<div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
<h3 style="margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #495057;">å®šæ—¶å…³æœº</h3>
<input type="number" id="sec" value="60" placeholder="ç§’æ•°" style="margin-bottom: 10px;">
<button class="btn-blue" onclick="setTimer()">å¼€å§‹å€’è®¡æ—¶</button>
</div>
<button class="btn-red" onclick="shutdown()">ç«‹å³å…³æœº</button>
<button class="btn-orange" onclick="restart()">é‡å¯ç”µè„‘</button>
<button class="btn-teal" onclick="sleep()">ä¼‘çœ </button>
<button class="btn-purple" onclick="lock()">é”å±</button>
<button class="btn-green" onclick="abort()">å–æ¶ˆå…³æœº</button>
</div>

<div class="card" id="cmd-section" style="display: none;">
<h2>âŒ¨ï¸ æ‰§è¡Œå‘½ä»¤</h2>
<input type="text" id="cmd" placeholder="è¾“å…¥CMDå‘½ä»¤">
<button class="btn-blue" onclick="runCmd()">æ‰§è¡Œ</button>

<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
<h3 style="margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #495057;">åº”ç”¨ç®¡ç†</h3>
<button class="btn-blue" onclick="getRunningApps()">è·å–è¿è¡Œåº”ç”¨</button>
<div id="app-list" style="max-height: 200px; overflow-y: auto; padding: 10px; background: #fff; border-radius: 6px; font-family: monospace; font-size: 11px; border: 1px solid #e9ecef; margin: 10px 0;">
<p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–è¿è¡Œä¸­çš„åº”ç”¨</p>
</div>
<input type="text" id="app-name" placeholder="è¾“å…¥è¦åœæ­¢çš„åº”ç”¨åç§°ï¼ˆå¦‚ notepad.exeï¼‰" style="margin-bottom: 10px;">
<button class="btn-red" onclick="stopApp()">åœæ­¢åº”ç”¨</button>
</div>
</div>

<div class="card" id="info-section" style="display: none;">
<h2>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h2>
<div id="sysinfo-content">
<p>CPUä½¿ç”¨ç‡: <span id="cpu-percent">--</span>%</p>
<p>å†…å­˜ä½¿ç”¨: <span id="mem-used">--</span>GB / <span id="mem-total">--</span>GB (<span id="mem-percent">--</span>%)</p>
<p>ç£ç›˜ä½¿ç”¨: <span id="disk-used">--</span>GB / <span id="disk-total">--</span>GB (<span id="disk-percent">--</span>%)</p>
<p>ç½‘ç»œå‘é€: <span id="net-sent">--</span>MB</p>
<p>ç½‘ç»œæ¥æ”¶: <span id="net-recv">--</span>MB</p>
<p>ç³»ç»Ÿå¯åŠ¨: <span id="sys-boot-time">--</span></p>
</div>
<button class="btn-green" onclick="getSysInfo()">åˆ·æ–°ç³»ç»Ÿä¿¡æ¯</button>

<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
<h3 style="margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #495057;">ç³»ç»Ÿæ—¥å¿—</h3>
<div id="syslog-content" style="max-height: 200px; overflow-y: auto; padding: 10px; background: #fff; border-radius: 6px; font-family: monospace; font-size: 11px; border: 1px solid #e9ecef;">
<p>åŠ è½½æ—¥å¿—ä¸­...</p>
</div>
<button class="btn-blue" onclick="getSysLog()">åˆ·æ–°æ—¥å¿—</button>
</div>
</div>

<div class="card" id="screen-section" style="display: none;">
<h2>ğŸ–¥ï¸ å±å¹•ç”»é¢</h2>
<div style="text-align: center; margin-bottom: 10px;">
<img id="screen-image" src="" alt="å±å¹•ç”»é¢" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid #ddd;">
</div>
<div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
<button class="btn-blue" onclick="getScreenShot()">è·å–å±å¹•æˆªå›¾</button>
<button class="btn-green" onclick="startRealTimeScreen()">å¼€å§‹å®æ—¶ç”»é¢</button>
<button class="btn-red" onclick="stopRealTimeScreen()">åœæ­¢å®æ—¶ç”»é¢</button>
<button class="btn-orange" id="quality-btn" onclick="toggleQuality()">ç”»è´¨: é«˜</button>
<div class="fps-control">
<button class="btn-teal" id="fps-btn" onclick="toggleFpsDropdown()">å¸§ç‡: 24</button>
<div id="fps-dropdown" class="fps-dropdown" style="display: none;">
<div class="fps-option" onclick="setFps(5)">5</div>
<div class="fps-option" onclick="setFps(10)">10</div>
<div class="fps-option" onclick="setFps(15)">15</div>
<div class="fps-option" onclick="setFps(24)">24</div>
<div class="fps-option" onclick="setFps(30)">30</div>
<div class="fps-option" onclick="setFps(45)">45</div>
<div class="fps-option" onclick="setFps(60)">60</div>
</div>
</div>
<div id="fps-counter" class="fps-counter">å½“å‰: 24 FPS</div>
</div>
<div style="margin-top: 10px; font-size: 12px; color: #666;">
<p>å®æ—¶ç”»é¢é€šè¿‡MJPEGæµå®ç°ï¼Œä½å»¶è¿Ÿã€çœå¸¦å®½</p>
</div>
</div>

<div class="card" id="message-section" style="display: none;">
<h2>ğŸ’¬ æ¶ˆæ¯ä¸­å¿ƒ</h2>
<div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
<h3 style="margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #495057;">å‘é€æ¶ˆæ¯</h3>
<input type="text" id="message-input" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯">
<button class="btn-blue" onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
</div>

<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
<h3 style="margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #495057;">æ¶ˆæ¯å†å²</h3>
<div id="message-history" style="max-height: 300px; overflow-y: auto; padding: 10px; background: #fff; border-radius: 6px; font-family: monospace; font-size: 11px; border: 1px solid #e9ecef;">
<p>æ¶ˆæ¯å†å²å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
</div>
<button class="btn-green" onclick="getMessageHistory()">è·å–æ¶ˆæ¯å†å²</button>
</div>

<div style="margin-top: 10px; font-size: 12px; color: #666;">
<p>æ¶ˆæ¯ä¸­å¿ƒæ”¯æŒå‘ç”µè„‘å‘é€å¼¹å‡ºæ¶ˆæ¯ï¼Œå¹¶æ¥æ”¶ç”µè„‘çš„å›å¤</p>
</div>
</div>

<div class="card" id="file-section" style="display: none;">
<h2>ğŸ“ æ–‡ä»¶ç®¡ç†</h2>
<div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
<h3 style="margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #495057;">å‘é€åˆ°ç”µè„‘</h3>
<input type="file" id="file-input" style="margin-bottom: 10px;">
<div style="display: flex; gap: 8px;">
<button class="btn-blue" onclick="sendFile()">å‘é€</button>
<button class="btn-red" onclick="cancelFile()">å–æ¶ˆ</button>
</div>

<!-- è¿›åº¦æ¡åŒºåŸŸ -->
<div id="upload-progress" style="margin-top: 15px; display: none;">
<div id="progress-file-info" style="margin-bottom: 8px; font-size: 14px;"></div>
<div style="background: #e9ecef; border-radius: 8px; overflow: hidden; margin-bottom: 8px;">
<div id="progress-bar" style="height: 20px; background: linear-gradient(90deg, #007bff, #0069d9); width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;"></div>
</div>
<div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #666;">
<div id="progress-details"></div>
<button class="btn-red" id="cancel-upload" style="padding: 4px 8px; font-size: 11px; width: auto;">å–æ¶ˆä¸Šä¼ </button>
</div>
</div>
</div>

<div style="margin-top: 15px;">
<h3 style="margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #495057;">æœ€è¿‘å‘é€ï¼š</h3>
<div id="recent-files" style="max-height: 200px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px;">
<p>æš‚æ— å‘é€è®°å½•</p>
</div>
</div>
</div>

</div>

<script>
function setTimer(){
    let s = document.getElementById('sec').value;
    fetch('/timer?s='+s);
    alert('å·²è®¾ç½® ' + s + ' ç§’åå…³æœº');
}
function shutdown(){
    if(confirm('ç¡®å®šè¦å…³æœºå—ï¼Ÿ')){
        fetch('/shutdown');
        alert('å·²æ‰§è¡Œå…³æœº');
    }
}
function restart(){
    if(confirm('ç¡®å®šè¦é‡å¯å—ï¼Ÿ')){
        fetch('/restart');
        alert('å·²æ‰§è¡Œé‡å¯');
    }
}
function sleep(){
    if(confirm('ç¡®å®šä¼‘çœ å—ï¼Ÿ')){
        fetch('/sleep');
        alert('å·²æ‰§è¡Œä¼‘çœ ');
    }
}
function lock(){
    if(confirm('ç¡®å®šé”å±å—ï¼Ÿ')){
        fetch('/lock');
        alert('å·²æ‰§è¡Œé”å±');
    }
}
function abort(){
    fetch('/abort');
    alert('å·²å–æ¶ˆ');
}
function runCmd(){
    let c = document.getElementById('cmd').value;
    fetch('/run?cmd='+encodeURIComponent(c));
    alert('å·²æ‰§è¡Œï¼š'+c);
}

function getRunningApps(){
    fetch('/running_apps')
    .then(response => response.json())
    .then(data => {
        const appList = document.getElementById('app-list');
        if(data.success){
            let html = '';
            data.apps.forEach(app => {
                html += `<div style="margin-bottom: 4px;">${app.name} (PID: ${app.pid})</div>`;
            });
            appList.innerHTML = html;
        } else {
            appList.innerHTML = `<div style="color: red;">è·å–åº”ç”¨åˆ—è¡¨å¤±è´¥: ${data.error}</div>`;
        }
    })
    .catch(error => {
        console.error('è·å–åº”ç”¨åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('app-list').innerHTML = '<div style="color: red;">è·å–åº”ç”¨åˆ—è¡¨å¤±è´¥</div>';
    });
}

function stopApp(){
    let appName = document.getElementById('app-name').value;
    if(appName){
        fetch(`/stop_app?name=${encodeURIComponent(appName)}`)
        .then(response => response.json())
        .then(data => {
            if(data.success){
                alert('åº”ç”¨å·²æˆåŠŸåœæ­¢');
                // åˆ·æ–°åº”ç”¨åˆ—è¡¨
                getRunningApps();
            } else {
                alert('åœæ­¢åº”ç”¨å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            console.error('åœæ­¢åº”ç”¨å¤±è´¥:', error);
            alert('åœæ­¢åº”ç”¨å¤±è´¥');
        });
    } else {
        alert('è¯·è¾“å…¥åº”ç”¨åç§°');
    }
}
function getSysInfo(){
    fetch('/sysinfo')
    .then(response => response.json())
    .then(data => {
        document.getElementById('cpu-percent').textContent = data.cpu_percent;
        document.getElementById('mem-used').textContent = data.memory.used;
        document.getElementById('mem-total').textContent = data.memory.total;
        document.getElementById('mem-percent').textContent = data.memory.percent;
        document.getElementById('disk-used').textContent = data.disk.used;
        document.getElementById('disk-total').textContent = data.disk.total;
        document.getElementById('disk-percent').textContent = data.disk.percent;
        document.getElementById('net-sent').textContent = data.network.bytes_sent;
        document.getElementById('net-recv').textContent = data.network.bytes_recv;
        if(data.system) {
            document.getElementById('sys-boot-time').textContent = data.system.boot_time || '--';
        }
    });
}

function getSysLog(){
    fetch('/syslog')
    .then(response => response.text())
    .then(data => {
        document.getElementById('syslog-content').innerHTML = data;
    });
}

// å®æ—¶å±å¹•ç›¸å…³å˜é‡
let networkErrorShown = false;
let currentQuality = localStorage.getItem('screenQuality') || 'high';
let currentFps = parseInt(localStorage.getItem('screenFps')) || 24;
let fpsDropdownVisible = false;
let isStreaming = false;
let frameCount = 0;
let lastFpsTime = 0;
let actualFps = 0;
let lowFpsCount = 0;
let warningShown = false;
let fpsCalculationStarted = false;
let frameDetectionInterval = null;
let imgLoadHandler = null;

// åˆå§‹åŒ–å±å¹•è®¾ç½®
function initScreenSettings() {
    // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
    updateQualityButton();
    updateFpsButton();
    updateFpsCounter('è®¡ç®—ä¸­...');
}

// æ›´æ–°ç”»è´¨æŒ‰é’®æ˜¾ç¤º
function updateQualityButton() {
    const btn = document.getElementById('quality-btn');
    let text = 'ç”»è´¨: ';
    switch (currentQuality) {
        case 'low':
            text += 'ä½';
            break;
        case 'medium':
            text += 'ä¸­';
            break;
        case 'high':
            text += 'é«˜';
            break;
    }
    btn.textContent = text;
    // ä¿å­˜åˆ° localStorage
    localStorage.setItem('screenQuality', currentQuality);
}

// æ›´æ–°å¸§ç‡æŒ‰é’®æ˜¾ç¤º
function updateFpsButton() {
    const btn = document.getElementById('fps-btn');
    btn.textContent = `å¸§ç‡: ${currentFps}`;
    // ä¿å­˜åˆ° localStorage
    localStorage.setItem('screenFps', currentFps.toString());
}

// æ›´æ–° FPS è®¡æ•°å™¨æ˜¾ç¤º
function updateFpsCounter(value) {
    const counter = document.getElementById('fps-counter');
    
    if (typeof value === 'string') {
        // æ˜¾ç¤ºçŠ¶æ€æ–‡æœ¬
        counter.className = 'fps-counter';
        counter.innerHTML = `<span style="font-size: 14px; color: #666;">${value}</span><br>
                             <span style="font-size: 11px; color: #999;">è®¾ç½®: ${currentFps} FPSï¼ˆç†è®ºï¼‰</span>`;
        return;
    }
    
    const actualFps = value;
    
    // ç¡®å®šæ˜¾ç¤ºé¢œè‰²å’Œå›¾æ ‡
    let className = 'fps-counter';
    let icon = 'âœ“';
    let statusText = '';
    
    if (actualFps >= 20) {
        className = 'fps-counter';
        icon = 'âœ“';
    } else if (actualFps >= 10) {
        className = 'fps-counter yellow';
        icon = 'âš ';
    } else {
        className = 'fps-counter red';
        icon = 'âœ—';
        statusText = ' ç½‘ç»œå¡é¡¿';
    }
    
    // ä¸»æ˜¾ç¤º
    counter.className = className;
    counter.innerHTML = `<span style="font-size: 16px; font-weight: bold;">${actualFps} FPS ${icon}</span>${statusText}<br>
                         <span style="font-size: 11px; color: #666;">è®¾ç½®: ${currentFps} FPS | å®é™…: ${actualFps} FPS</span>`;
}

// æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§
function checkNetworkStability(fps) {
    if (fps < 10) {
        lowFpsCount++;
    } else {
        lowFpsCount = 0;
        warningShown = false;
    }
    
    // è¿ç»­3ç§’å®é™…FPS<10æ‰æç¤º
    if (lowFpsCount >= 3 && !warningShown && isStreaming) {
        showWarningToast('ç½‘ç»œä¸ç¨³å®šï¼Œå»ºè®®é™ä½ç”»è´¨', 5000);
        warningShown = true;
    }
    
    // æ£€æµ‹å¼‚å¸¸æƒ…å†µï¼šå®é™…FPSè¿œä½äºè®¾ç½®å€¼
    if (fps < currentFps * 0.5 && fpsCalculationStarted) {
        lowFpsCount++;
        if (lowFpsCount >= 3 && !warningShown) {
            showWarningToast('æ£€æµ‹å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§', 5000);
            warningShown = true;
        }
    }
}

// å¯åŠ¨å¸§ç‡æ£€æµ‹
function startFpsDetection() {
    const img = document.getElementById('screen-image');
    
    // é‡ç½®çŠ¶æ€
    frameCount = 0;
    lastFpsTime = performance.now();
    actualFps = 0;
    lowFpsCount = 0;
    warningShown = false;
    fpsCalculationStarted = false;
    
    // å®šä¹‰loadäº‹ä»¶å¤„ç†å‡½æ•°
    imgLoadHandler = function() {
        frameCount++;
        
        const now = performance.now();
        if (now - lastFpsTime >= 1000) {
            actualFps = Math.min(frameCount, currentFps);
            
            if (actualFps === 0 && isStreaming) {
                updateFpsCounter('è¿æ¥ä¸­...');
            } else {
                updateFpsCounter(actualFps);
                
                // æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§ï¼ˆå»¶è¿Ÿ5ç§’åå¼€å§‹ï¼‰
                if (fpsCalculationStarted && isStreaming) {
                    checkNetworkStability(actualFps);
                }
            }
            
            frameCount = 0;
            lastFpsTime = now;
        }
    };
    
    // ç»‘å®šloadäº‹ä»¶
    img.onload = imgLoadHandler;
    
    // å»¶è¿Ÿ5ç§’åå†å¼€å§‹åˆ¤æ–­ç½‘ç»œç¨³å®šæ€§
    setTimeout(() => {
        fpsCalculationStarted = true;
    }, 5000);
}

// åœæ­¢å¸§ç‡æ£€æµ‹
function stopFpsDetection() {
    const img = document.getElementById('screen-image');
    
    // è§£ç»‘loadäº‹ä»¶
    if (imgLoadHandler) {
        img.onload = null;
        imgLoadHandler = null;
    }
    
    fpsCalculationStarted = false;
    updateFpsCounter('è®¡ç®—ä¸­...');
}

// åˆ‡æ¢ç”»è´¨
function toggleQuality() {
    switch (currentQuality) {
        case 'low':
            currentQuality = 'medium';
            break;
        case 'medium':
            currentQuality = 'high';
            break;
        case 'high':
            currentQuality = 'low';
            break;
    }
    updateQualityButton();
    
    // ä¿å­˜åˆ° localStorage
    localStorage.setItem('screenQuality', currentQuality);
    
    // å®æ—¶ç”»é¢å¼€å¯æ—¶ï¼Œè‡ªåŠ¨åº”ç”¨æ–°å‚æ•°
    if (isStreaming) {
        const img = document.getElementById('screen-image');
        if (img.src.includes('/stream')) {
            const streamUrl = `http://${window.location.hostname}:5002/stream?quality=${currentQuality}&fps=${currentFps}`;
            img.src = streamUrl;
        }
    }
    // é›¶æç¤ºï¼šä¸æ˜¾ç¤ºä»»ä½•toast
}

// åˆ‡æ¢å¸§ç‡ä¸‹æ‹‰èœå•
function toggleFpsDropdown() {
    const dropdown = document.getElementById('fps-dropdown');
    fpsDropdownVisible = !fpsDropdownVisible;
    dropdown.style.display = fpsDropdownVisible ? 'block' : 'none';
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
    if (fpsDropdownVisible) {
        setTimeout(() => {
            document.addEventListener('click', closeFpsDropdown);
        }, 10);
    }
}

// å…³é—­å¸§ç‡ä¸‹æ‹‰èœå•
function closeFpsDropdown(event) {
    if (!event.target.closest('.fps-control')) {
        const dropdown = document.getElementById('fps-dropdown');
        dropdown.style.display = 'none';
        fpsDropdownVisible = false;
        document.removeEventListener('click', closeFpsDropdown);
    }
}

// è®¾ç½®å¸§ç‡
function setFps(fps) {
    currentFps = fps;
    updateFpsButton();
    updateFpsCounter();
    
    // å…³é—­ä¸‹æ‹‰èœå•
    const dropdown = document.getElementById('fps-dropdown');
    dropdown.style.display = 'none';
    fpsDropdownVisible = false;
    document.removeEventListener('click', closeFpsDropdown);
    
    // ä¿å­˜åˆ° localStorage
    localStorage.setItem('screenFps', currentFps.toString());
    
    // å®æ—¶ç”»é¢å¼€å¯æ—¶ï¼Œè‡ªåŠ¨åº”ç”¨æ–°å‚æ•°
    if (isStreaming) {
        const img = document.getElementById('screen-image');
        if (img.src.includes('/stream')) {
            const streamUrl = `http://${window.location.hostname}:5002/stream?quality=${currentQuality}&fps=${currentFps}`;
            img.src = streamUrl;
        }
    }
    // é›¶æç¤ºï¼šä¸æ˜¾ç¤ºä»»ä½•toast
}

function getScreenShot(showAlert = true){
    const timestamp = new Date().getTime();
    fetch(`/screenshot?_=${timestamp}`)
    .then(response => response.blob())
    .then(blob => {
        const img = document.getElementById('screen-image');
        if (img.src.startsWith('blob:')) {
            URL.revokeObjectURL(img.src);
        }
        const url = URL.createObjectURL(blob);
        img.src = url;
        // ç½‘ç»œæ¢å¤ï¼Œé‡ç½®é”™è¯¯æç¤ºçŠ¶æ€
        networkErrorShown = false;
    })
    .catch(error => {
        console.error('è·å–å±å¹•æˆªå›¾å¤±è´¥:', error);
        if (showAlert) {
            alert('è·å–å±å¹•æˆªå›¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            networkErrorShown = true;
        }
    });
}

function startRealTimeScreen(){
    const img = document.getElementById('screen-image');
    // é‡ç½®çŠ¶æ€
    frameCount = 0;
    lastFpsTime = performance.now();
    actualFps = 0;
    lowFpsCount = 0;
    warningShown = false;
    fpsCalculationStarted = false;
    
    // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
    updateFpsCounter('è¿æ¥ä¸­...');
    
    // è®¾ç½®isStreamingæ ‡å¿—ä¸ºtrue
    isStreaming = true;
    
    // å¯åŠ¨å¸§ç‡æ£€æµ‹
    startFpsDetection();
    
    // è®¾ç½®imgçš„srcä¸ºMJPEGæµåœ°å€ï¼Œå¸¦ä¸Šç”»è´¨ã€å¸§ç‡å‚æ•°å’Œæ—¶é—´æˆ³
    const timestamp = new Date().getTime();
    const streamUrl = `http://${window.location.hostname}:5002/stream?quality=${currentQuality}&fps=${currentFps}&_=${timestamp}`;
    img.src = streamUrl;
    
    // æ˜¾ç¤ºæç¤º
    showInfoToast('å·²å¼€å§‹å®æ—¶ç”»é¢', 2000);
}

function stopRealTimeScreen(){
    const img = document.getElementById('screen-image');
    // æ¸…ç©ºimgçš„src
    img.src = '';
    showInfoToast('å·²åœæ­¢å®æ—¶ç”»é¢', 2000);
    // é‡ç½®isStreamingæ ‡å¿—ä¸ºfalse
    isStreaming = false;
    // åœæ­¢å¸§ç‡æ£€æµ‹
    stopFpsDetection();
}

// æ˜¾ç¤ºæŒ‡å®šéƒ¨åˆ†ï¼Œéšè—å…¶ä»–éƒ¨åˆ†
function showSection(section){
    // éšè—æ‰€æœ‰å¡ç‰‡
    document.getElementById('system-section').style.display = 'none';
    document.getElementById('cmd-section').style.display = 'none';
    document.getElementById('info-section').style.display = 'none';
    document.getElementById('screen-section').style.display = 'none';
    document.getElementById('message-section').style.display = 'none';
    document.getElementById('file-section').style.display = 'none';
    document.getElementById('about-section').style.display = 'none';
    
    // ç§»é™¤æ‰€æœ‰å¯¼èˆªæŒ‰é’®çš„æ´»åŠ¨çŠ¶æ€
    const navButtons = document.querySelectorAll('.nav-btn');
    navButtons.forEach(btn => btn.classList.remove('active'));
    
    // æ˜¾ç¤ºé€‰å®šçš„å¡ç‰‡
    document.getElementById(`${section}-section`).style.display = 'block';
    
    // è®¾ç½®å¯¹åº”å¯¼èˆªæŒ‰é’®ä¸ºæ´»åŠ¨çŠ¶æ€
    event.target.classList.add('active');
    
    // å¦‚æœæ˜¾ç¤ºçš„æ˜¯ç³»ç»Ÿä¿¡æ¯ï¼Œè‡ªåŠ¨åˆ·æ–°å†…å®¹
    if (section === 'info') {
        getSysInfo();
        getSysLog();
    }
    
    // å¦‚æœæ˜¾ç¤ºçš„æ˜¯æ¶ˆæ¯ä¸­å¿ƒï¼Œè‡ªåŠ¨è·å–æ¶ˆæ¯å†å²
    if (section === 'message') {
        getMessageHistory();
    }
    
    // å¦‚æœæ˜¾ç¤ºçš„æ˜¯æ–‡ä»¶ç®¡ç†ï¼Œè‡ªåŠ¨è·å–æœ€è¿‘å‘é€è®°å½•
    if (section === 'file') {
        getRecentFiles();
    }
}

// æ¶ˆæ¯ç›¸å…³å‡½æ•°
function sendMessage(){
    let message = document.getElementById('message-input').value;
    if(message){
        // æ˜¾ç¤ºå‘é€ä¸­æç¤º
        showInfoToast('æ­£åœ¨å‘é€æ¶ˆæ¯...');
        
        fetch('/send_message?msg='+encodeURIComponent(message))
        .then(response => response.json())
        .then(data => {
            if(data.success){
                showSuccessToast('æ¶ˆæ¯å·²å‘é€ï¼Œç”µè„‘å°†å¼¹å‡ºæ¶ˆæ¯æ¡†');
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('message-input').value = '';
                // åˆ·æ–°æ¶ˆæ¯å†å²
                getMessageHistory();
            } else {
                showErrorToast('å‘é€æ¶ˆæ¯å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            showErrorToast('å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        });
    } else {
        showWarningToast('è¯·è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯');
    }
}

function getMessageHistory(){
    fetch('/message_history')
    .then(response => response.json())
    .then(data => {
        const messageHistory = document.getElementById('message-history');
        if(data.success){
            if(data.messages && data.messages.length > 0){
                let html = '';
                data.messages.forEach(msg => {
                    const time = new Date(msg.timestamp).toLocaleString();
                    html += `<div style="margin-bottom: 8px; padding: 8px; background: ${msg.type === 'sent' ? '#e3f2fd' : '#e8f5e8'}; border-radius: 6px;">`;
                    html += `<div style="font-weight: bold;">${msg.type === 'sent' ? 'å‘é€' : 'æ¥æ”¶'} (${time})</div>`;
                    html += `<div>${msg.content}</div>`;
                    html += `</div>`;
                });
                messageHistory.innerHTML = html;
            } else {
                messageHistory.innerHTML = '<p>æš‚æ— æ¶ˆæ¯å†å²</p>';
            }
        } else {
            messageHistory.innerHTML = `<div style="color: red;">è·å–æ¶ˆæ¯å†å²å¤±è´¥: ${data.error}</div>`;
        }
    })
    .catch(error => {
        console.error('è·å–æ¶ˆæ¯å†å²å¤±è´¥:', error);
        document.getElementById('message-history').innerHTML = '<div style="color: red;">è·å–æ¶ˆæ¯å†å²å¤±è´¥</div>';
    });
}

// Toastæç¤ºæ¡†ç³»ç»Ÿ
class ToastSystem {
    constructor() {
        this.container = null;
        this.toasts = [];
        this.init();
    }
    
    // åˆå§‹åŒ–Toastå®¹å™¨
    init() {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å®¹å™¨
        this.container = document.querySelector('.toast-container');
        if (!this.container) {
            this.container = document.createElement('div');
            this.container.className = 'toast-container';
            document.body.appendChild(this.container);
        }
    }
    
    // æ˜¾ç¤ºToast
    show(message, type = 'success', duration = 3000) {
        // åˆ›å»ºToastå…ƒç´ 
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        // è®¾ç½®å†…å®¹
        const content = document.createElement('div');
        content.className = 'toast-content';
        
        // æ·»åŠ å›¾æ ‡
        const icon = document.createElement('div');
        icon.className = 'toast-icon';
        switch (type) {
            case 'success':
                icon.textContent = 'âœ“';
                break;
            case 'error':
                icon.textContent = 'âœ—';
                break;
            case 'warning':
                icon.textContent = 'âš ';
                break;
            case 'info':
                icon.textContent = 'â„¹';
                break;
        }
        
        // æ·»åŠ æ¶ˆæ¯
        const messageEl = document.createElement('div');
        messageEl.className = 'toast-message';
        messageEl.textContent = message;
        
        // æ·»åŠ è¿›åº¦æ¡
        const progress = document.createElement('div');
        progress.className = 'toast-progress';
        
        // ç»„è£…å…ƒç´ 
        content.appendChild(icon);
        content.appendChild(messageEl);
        toast.appendChild(content);
        toast.appendChild(progress);
        
        // æ·»åŠ åˆ°å®¹å™¨
        this.container.appendChild(toast);
        
        // åŠ¨ç”»æ˜¾ç¤º
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // å­˜å‚¨Toastä¿¡æ¯
        const toastInfo = {
            element: toast,
            progress: progress,
            duration: duration,
            startTime: Date.now(),
            pausedTime: 0,
            isPaused: false,
            interval: null
        };
        this.toasts.push(toastInfo);
        
        // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
        this.startProgress(toastInfo);
        
        // é¼ æ ‡æ‚¬åœæš‚åœ
        toast.addEventListener('mouseenter', () => {
            this.pauseToast(toastInfo);
        });
        
        // é¼ æ ‡ç§»å‡ºç»§ç»­
        toast.addEventListener('mouseleave', () => {
            this.resumeToast(toastInfo);
        });
        
        // ç‚¹å‡»å…³é—­
        toast.addEventListener('click', () => {
            this.hideToast(toastInfo);
        });
        
        return toastInfo;
    }
    
    // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
    startProgress(toastInfo) {
        const { element, progress, duration, startTime } = toastInfo;
        
        toastInfo.interval = setInterval(() => {
            if (toastInfo.isPaused) return;
            
            const elapsed = Date.now() - startTime - toastInfo.pausedTime;
            const percentage = Math.max(0, 1 - (elapsed / duration));
            
            progress.style.width = `${percentage * 100}%`;
            
            if (elapsed >= duration) {
                clearInterval(toastInfo.interval);
                this.hideToast(toastInfo);
            }
        }, 10);
    }
    
    // æš‚åœToast
    pauseToast(toastInfo) {
        if (!toastInfo.isPaused) {
            toastInfo.isPaused = true;
            clearInterval(toastInfo.interval);
        }
    }
    
    // ç»§ç»­Toast
    resumeToast(toastInfo) {
        if (toastInfo.isPaused) {
            toastInfo.isPaused = false;
            toastInfo.startTime = Date.now() - (toastInfo.duration - (toastInfo.progress.offsetWidth / toastInfo.element.offsetWidth) * toastInfo.duration);
            this.startProgress(toastInfo);
        }
    }
    
    // éšè—Toast
    hideToast(toastInfo) {
        clearInterval(toastInfo.interval);
        
        const { element } = toastInfo;
        element.classList.remove('show');
        element.classList.add('hide');
        
        setTimeout(() => {
            if (element.parentNode) {
                element.parentNode.removeChild(element);
            }
            
            // ä»æ•°ç»„ä¸­ç§»é™¤
            const index = this.toasts.findIndex(info => info.element === element);
            if (index > -1) {
                this.toasts.splice(index, 1);
            }
        }, 300);
    }
    
    // æ˜¾ç¤ºæˆåŠŸToast
    success(message, duration = 3000) {
        return this.show(message, 'success', duration);
    }
    
    // æ˜¾ç¤ºé”™è¯¯Toast
    error(message, duration = 4000) {
        return this.show(message, 'error', duration);
    }
    
    // æ˜¾ç¤ºè­¦å‘ŠToast
    warning(message, duration = 3500) {
        return this.show(message, 'warning', duration);
    }
    
    // æ˜¾ç¤ºä¿¡æ¯Toast
    info(message, duration = 3000) {
        return this.show(message, 'info', duration);
    }
}

// åˆå§‹åŒ–Toastç³»ç»Ÿ
const toastSystem = new ToastSystem();

// å…¨å±€showToastå‡½æ•°
function showToast(message, type = 'success', duration = 3000) {
    return toastSystem.show(message, type, duration);
}

// ä¾¿æ·æ–¹æ³•
function showSuccessToast(message, duration) {
    return toastSystem.success(message, duration);
}

function showErrorToast(message, duration) {
    return toastSystem.error(message, duration);
}

function showWarningToast(message, duration) {
    return toastSystem.warning(message, duration);
}

function showInfoToast(message, duration) {
    return toastSystem.info(message, duration);
}

// æ–‡ä»¶ç®¡ç†ç›¸å…³å‡½æ•°
let xhr = null;
let uploadStartTime = 0;
let uploadStartBytes = 0;
let uploadSpeed = 0;
let uploadSpeedUpdateInterval = null;

function sendFile() {
    const fileInput = document.getElementById('file-input');
    const file = fileInput.files[0];
    
    if (!file) {
        showWarningToast('è¯·é€‰æ‹©è¦å‘é€çš„æ–‡ä»¶');
        return;
    }
    
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹ï¼ˆç¦æ­¢æ‰§è¡Œæ–‡ä»¶ï¼‰
    const executableExtensions = ['.exe', '.bat', '.cmd', '.com', '.msi', '.ps1', '.js', '.vbs'];
    const fileName = file.name.toLowerCase();
    for (const ext of executableExtensions) {
        if (fileName.endsWith(ext)) {
            showErrorToast('ç¦æ­¢å‘é€æ‰§è¡Œæ–‡ä»¶');
            return;
        }
    }
    
    // æ˜¾ç¤ºè¿›åº¦æ¡
    const progressArea = document.getElementById('upload-progress');
    const progressFileInfo = document.getElementById('progress-file-info');
    const progressBar = document.getElementById('progress-bar');
    const progressDetails = document.getElementById('progress-details');
    
    // è®¡ç®—æ–‡ä»¶å¤§å°
    const fileSize = file.size;
    const fileSizeFormatted = formatFileSize(fileSize);
    
    // æ›´æ–°è¿›åº¦æ¡ä¿¡æ¯
    progressFileInfo.textContent = `æ–‡ä»¶å: ${file.name} (${fileSizeFormatted})`;
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressDetails.textContent = '0MB/0MB | é€Ÿåº¦: 0KB/s | å‰©ä½™æ—¶é—´: è®¡ç®—ä¸­...';
    progressArea.style.display = 'block';
    
    // é‡ç½®ä¸Šä¼ çŠ¶æ€
    uploadStartTime = Date.now();
    uploadStartBytes = 0;
    uploadSpeed = 0;
    
    // åˆ›å»ºFormData
    const formData = new FormData();
    formData.append('file', file);
    
    // åˆ›å»ºXMLHttpRequest
    xhr = new XMLHttpRequest();
    
    // ä¸Šä¼ è¿›åº¦äº‹ä»¶
    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            const loaded = e.loaded;
            const total = e.total;
            const percent = Math.round((loaded / total) * 100);
            
            // è®¡ç®—ä¸Šä¼ é€Ÿåº¦
            const now = Date.now();
            const elapsed = (now - uploadStartTime) / 1000; // ç§’
            
            if (elapsed > 0.5) { // æ¯0.5ç§’è®¡ç®—ä¸€æ¬¡é€Ÿåº¦
                uploadSpeed = (loaded - uploadStartBytes) / elapsed / (1024 * 1024); // MB/s
                uploadStartBytes = loaded;
                uploadStartTime = now;
            }
            
            // è®¡ç®—å‰©ä½™æ—¶é—´
            const remainingBytes = total - loaded;
            const remainingTime = uploadSpeed > 0 ? remainingBytes / (uploadSpeed * 1024 * 1024) : 0;
            
            // æ ¼å¼åŒ–æ•°æ®
            const loadedFormatted = formatFileSize(loaded);
            const speedFormatted = uploadSpeed < 1 ? `${(uploadSpeed * 1024).toFixed(1)}KB/s` : `${uploadSpeed.toFixed(1)}MB/s`;
            const remainingFormatted = formatTime(remainingTime);
            
            // æ›´æ–°è¿›åº¦æ¡
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${percent}%`;
            
            // æ›´æ–°è¿›åº¦è¯¦æƒ…
            progressDetails.textContent = `${loadedFormatted}/${fileSizeFormatted} | é€Ÿåº¦: ${speedFormatted} | å‰©ä½™æ—¶é—´: ${remainingFormatted}`;
            
            // åŠ¨æ€æ”¹å˜è¿›åº¦æ¡é¢œè‰²
            if (percent < 50) {
                progressBar.style.background = 'linear-gradient(90deg, #007bff, #0069d9)';
            } else if (percent < 90) {
                progressBar.style.background = 'linear-gradient(90deg, #ffc107, #e0a800)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, #28a745, #218838)';
            }
        }
    };
    
    // ä¸Šä¼ å®Œæˆäº‹ä»¶
    xhr.onload = function() {
        clearInterval(uploadSpeedUpdateInterval);
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success) {
                    showSuccessToast('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œç­‰å¾…ç”µè„‘ç«¯ç¡®è®¤');
                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                    fileInput.value = '';
                    // æ›´æ–°æœ€è¿‘å‘é€åˆ—è¡¨
                    getRecentFiles();
                } else {
                    showErrorToast('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showErrorToast('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯');
            }
        } else {
            showErrorToast('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: æœåŠ¡å™¨é”™è¯¯');
        }
        // éšè—è¿›åº¦æ¡
        setTimeout(() => {
            progressArea.style.display = 'none';
        }, 1000);
    };
    
    // ä¸Šä¼ é”™è¯¯äº‹ä»¶
    xhr.onerror = function() {
        clearInterval(uploadSpeedUpdateInterval);
        showErrorToast('æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        // éšè—è¿›åº¦æ¡
        setTimeout(() => {
            progressArea.style.display = 'none';
        }, 1000);
    };
    
    // ä¸Šä¼ å–æ¶ˆäº‹ä»¶
    xhr.onabort = function() {
        clearInterval(uploadSpeedUpdateInterval);
        showInfoToast('ä¸Šä¼ å·²å–æ¶ˆ');
        // éšè—è¿›åº¦æ¡
        setTimeout(() => {
            progressArea.style.display = 'none';
        }, 1000);
    };
    
    // å‘é€è¯·æ±‚
    xhr.open('POST', '/upload', true);
    xhr.send(formData);
    
    // ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
    document.getElementById('cancel-upload').onclick = function() {
        if (xhr) {
            xhr.abort();
        }
    };
}

function cancelFile() {
    document.getElementById('file-input').value = '';
    // éšè—è¿›åº¦æ¡
    document.getElementById('upload-progress').style.display = 'none';
    // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ä¸Šä¼ 
    if (xhr) {
        xhr.abort();
    }
    showInfoToast('å·²å–æ¶ˆæ–‡ä»¶é€‰æ‹©');
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes < 1024) {
        return bytes + 'B';
    } else if (bytes < 1024 * 1024) {
        return (bytes / 1024).toFixed(1) + 'KB';
    } else if (bytes < 1024 * 1024 * 1024) {
        return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
    } else {
        return (bytes / (1024 * 1024 * 1024)).toFixed(1) + 'GB';
    }
}

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(seconds) {
    if (seconds < 60) {
        return `çº¦${Math.ceil(seconds)}ç§’`;
    } else {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.ceil(seconds % 60);
        return `çº¦${minutes}åˆ†${remainingSeconds}ç§’`;
    }
}

function getRecentFiles() {
    fetch('/recent_files')
    .then(response => response.json())
    .then(data => {
        const recentFiles = document.getElementById('recent-files');
        if (data.success && data.files.length > 0) {
            let html = '';
            data.files.forEach(file => {
                let statusIcon = 'â³';
                let statusText = 'ç­‰å¾…ä¸­';
                
                switch (file.status) {
                    case 'completed':
                        statusIcon = 'âœ“';
                        statusText = 'å·²æ¥æ”¶';
                        break;
                    case 'rejected':
                        statusIcon = 'âœ—';
                        statusText = 'å¯¹æ–¹æ‹’ç»';
                        break;
                    case 'transferring':
                        statusIcon = 'ğŸ“Š';
                        statusText = 'ä¼ è¾“ä¸­';
                        break;
                }
                
                html += `<div style="margin-bottom: 8px; padding: 8px; background: #e3f2fd; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">`;
                html += `<div>`;
                html += `<div style="font-weight: bold;">${file.name}</div>`;
                html += `<div style="font-size: 12px; color: #666;">${file.size} ${statusText}</div>`;
                html += `</div>`;
                html += `<div style="font-size: 16px;">${statusIcon}</div>`;
                html += `</div>`;
            });
            recentFiles.innerHTML = html;
        } else {
            recentFiles.innerHTML = '<p>æš‚æ— å‘é€è®°å½•</p>';
        }
    })
    .catch(error => {
        console.error('è·å–æœ€è¿‘å‘é€è®°å½•å¤±è´¥:', error);
        document.getElementById('recent-files').innerHTML = '<p style="color: red;">è·å–è®°å½•å¤±è´¥</p>';
    });
}

// SSEè¿æ¥ç›¸å…³å˜é‡
let source = null;
let reconnectAttempts = 0;
let maxReconnectDelay = 30000;
let lastMessageId = 0;
let lastHeartbeatTime = Date.now();
let heartbeatInterval = null;
let connectionStatusToast = null;
let hasShownConnected = false;  // é¦–æ¬¡è¿æ¥æ˜¯å¦å·²æç¤º
let isReconnecting = false;     // æ˜¯å¦æ­£åœ¨é‡è¿
let lastConnectionState = null;   // ä¸Šæ¬¡çŠ¶æ€

// åˆå§‹åŒ–SSEè¿æ¥
function initSSE() {
    try {
        // åªæœ‰åœ¨é‡è¿æ—¶æ‰æ˜¾ç¤ºè¿æ¥ä¸­çŠ¶æ€
        if (isReconnecting) {
            showConnectionStatus('connecting');
        }
        
        // åˆ›å»ºSSEè¿æ¥
        const url = '/events';
        console.log('æ­£åœ¨å»ºç«‹SSEè¿æ¥:', url);
        source = new EventSource(url);
        
        source.onopen = function() {
            console.log('SSEè¿æ¥å·²å»ºç«‹');
            // é‡ç½®é‡è¿å°è¯•æ¬¡æ•°
            reconnectAttempts = 0;
            
            // æ ¹æ®è¿æ¥çŠ¶æ€æ˜¾ç¤ºä¸åŒæç¤º
            if (lastConnectionState === 'disconnected') {
                // é‡è¿æˆåŠŸ
                showConnectionStatus('connected');
            } else if (!hasShownConnected) {
                // é¦–æ¬¡è¿æ¥ï¼Œé™é»˜
                hasShownConnected = true;
            }
            
            // æ›´æ–°çŠ¶æ€
            lastConnectionState = 'connected';
            isReconnecting = false;
            
            // è¡¥å…¨ç¦»çº¿æœŸé—´çš„æ¶ˆæ¯
            fetchMissedMessages();
            // é‡ç½®å¿ƒè·³æ—¶é—´
            lastHeartbeatTime = Date.now();
            // å¯åŠ¨å¿ƒè·³æ£€æµ‹
            startHeartbeatCheck();
        };
        
        source.onmessage = function(event) {
            try {
                console.log('æ”¶åˆ°SSEæ¶ˆæ¯:', event.data);
                // æ›´æ–°å¿ƒè·³æ—¶é—´
                lastHeartbeatTime = Date.now();
                
                // å¤„ç†å¿ƒè·³æ¶ˆæ¯
                if (event.data === 'ping') {
                    return;
                }
                
                // å¤„ç†è¿æ¥ç¡®è®¤æ¶ˆæ¯
                if (event.data === 'connected') {
                    return;
                }
                
                // è§£ææ¶ˆæ¯æ•°æ®
                const data = JSON.parse(event.data);
                console.log('è§£æåçš„SSEæ¶ˆæ¯:', data);
                
                // æ›´æ–°æœ€åæ¶ˆæ¯ID
                if (data.id) {
                    lastMessageId = data.id;
                }
                
                // å¤„ç†æ¶ˆæ¯æ ¼å¼
                let message = data;
                if (data.type && data.message) {
                    message = data.message;
                }
                
                // å¤„ç†æ–‡ä»¶çŠ¶æ€æ›´æ–°
                if (data.type === 'file_status') {
                    getRecentFiles();
                    if (data.status === 'completed') {
                        showSuccessToast(`æ–‡ä»¶ ${data.file_name} å·²è¢«æ¥æ”¶`);
                    } else if (data.status === 'rejected') {
                        showErrorToast(`æ–‡ä»¶ ${data.file_name} è¢«æ‹’ç»`);
                    } else if (data.status === 'transferring') {
                        showInfoToast(`æ–‡ä»¶ ${data.file_name} æ­£åœ¨ä¼ è¾“ä¸­`);
                    }
                    return;
                }
                
                // åˆ·æ–°æ¶ˆæ¯å†å²
                getMessageHistory();
                
                // æ˜¾ç¤ºToastæç¤º
                if (message.type === 'received') {
                    showSuccessToast(`æ”¶åˆ°å›å¤: ${message.content}`);
                }
            } catch (error) {
                console.error('å¤„ç†SSEæ¶ˆæ¯å¤±è´¥:', error);
                showErrorToast('å¤„ç†æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        };
        
        source.onerror = function(error) {
            console.error('SSEé”™è¯¯:', error);
            // å…³é—­è¿æ¥
            if (source) {
                source.close();
            }
            // è®¡ç®—é‡è¿å»¶è¿Ÿ
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), maxReconnectDelay);
            
            // åªæœ‰çŠ¶æ€å˜åŒ–æ—¶æ‰æ˜¾ç¤ºæç¤º
            if (lastConnectionState !== 'disconnected') {
                showConnectionStatus('disconnected', Math.round(delay / 1000));
                lastConnectionState = 'disconnected';
            }
            
            // æ›´æ–°çŠ¶æ€
            isReconnecting = true;
            
            // å»¶è¿Ÿåé‡è¿
            setTimeout(initSSE, delay);
            // å¢åŠ é‡è¿å°è¯•æ¬¡æ•°
            reconnectAttempts++;
            // æ¸…é™¤å¿ƒè·³æ£€æµ‹
            clearHeartbeatCheck();
        };
    } catch (error) {
        console.error('åˆå§‹åŒ–SSEå¤±è´¥:', error);
        // è®¡ç®—é‡è¿å»¶è¿Ÿ
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), maxReconnectDelay);
        
        // åªæœ‰çŠ¶æ€å˜åŒ–æ—¶æ‰æ˜¾ç¤ºæç¤º
        if (lastConnectionState !== 'disconnected') {
            showConnectionStatus('disconnected', Math.round(delay / 1000));
            lastConnectionState = 'disconnected';
        }
        
        // æ›´æ–°çŠ¶æ€
        isReconnecting = true;
        
        // å»¶è¿Ÿåé‡è¿
        setTimeout(initSSE, delay);
        // å¢åŠ é‡è¿å°è¯•æ¬¡æ•°
        reconnectAttempts++;
    }
}

// æ˜¾ç¤ºè¿æ¥çŠ¶æ€
function showConnectionStatus(status, delaySeconds = 0) {
    // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€æç¤º
    if (connectionStatusToast) {
        toastSystem.hideToast(connectionStatusToast);
    }
    
    switch (status) {
        case 'connecting':
            connectionStatusToast = toastSystem.info('ğŸŸ¡ è¿æ¥ä¸­...', 0);
            break;
        case 'connected':
            connectionStatusToast = toastSystem.success('ğŸŸ¢ å·²æ¢å¤è¿æ¥', 3000);
            break;
        case 'disconnected':
            connectionStatusToast = toastSystem.error(`ğŸ”´ è¿æ¥æ–­å¼€ï¼Œ${delaySeconds}ç§’åé‡è¿`, 0); // 0è¡¨ç¤ºä¸è‡ªåŠ¨å…³é—­
            break;
    }
}

// è¡¥å…¨ç¦»çº¿æœŸé—´çš„æ¶ˆæ¯
function fetchMissedMessages() {
    if (lastMessageId > 0) {
        fetch(`http://${window.location.hostname}:5002/missed_messages?last_id=${lastMessageId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.messages && data.messages.length > 0) {
                    console.log('è·å–åˆ°ç¦»çº¿æ¶ˆæ¯:', data.messages.length, 'æ¡');
                    // åˆ·æ–°æ¶ˆæ¯å†å²
                    getMessageHistory();
                    // æ˜¾ç¤ºç¦»çº¿æ¶ˆæ¯æç¤º
                    showSuccessToast(`æ”¶åˆ° ${data.messages.length} æ¡ç¦»çº¿æ¶ˆæ¯`);
                }
            })
            .catch(error => {
                console.error('è·å–ç¦»çº¿æ¶ˆæ¯å¤±è´¥:', error);
            });
    }
}

// å¯åŠ¨å¿ƒè·³æ£€æµ‹
function startHeartbeatCheck() {
    // æ¸…é™¤ä¹‹å‰çš„å¿ƒè·³æ£€æµ‹
    clearHeartbeatCheck();
    
    // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡å¿ƒè·³
    heartbeatInterval = setInterval(() => {
        const now = Date.now();
        // å¦‚æœè¶…è¿‡60ç§’æœªæ”¶åˆ°æ¶ˆæ¯ï¼Œä¸»åŠ¨æ–­å¼€é‡è¿
        if (now - lastHeartbeatTime > 60000) {
            console.log('å¿ƒè·³è¶…æ—¶ï¼Œä¸»åŠ¨æ–­å¼€é‡è¿');
            if (source) {
                source.close();
            }
            // è§¦å‘é‡è¿
            initSSE();
        }
    }, 10000);
}

// æ¸…é™¤å¿ƒè·³æ£€æµ‹
function clearHeartbeatCheck() {
    if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
    }
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ—¥å¿—
window.onload = function(){
    getSysLog();
    // åˆå§‹åŒ–å±å¹•è®¾ç½®
    initScreenSettings();
    // åˆå§‹åŒ–SSEè¿æ¥
    initSSE();
};
</script>
</body>
</html>